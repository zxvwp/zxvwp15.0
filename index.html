<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>zxvwp 15.0</title>
  <script src="https://unpkg.com/dexie@3.2.2/dist/dexie.min.js"></script>
  <style>
    body {
      background-color: black;
      color: lime;
      font-family: monospace;
      padding: 10px;
    }
    #output {
      white-space: pre-wrap;
      min-height: 80vh;
    }
    #input {
      width: 100%;
      background: black;
      color: lime;
      border: none;
      font-family: monospace;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="profileBar">| tag : --- | cash : 0 | age : 0 | job : none | income : 0 |</div>
  <div id="output"></div>
  <input id="input" autocomplete="off" />

  <script>
    const db = new Dexie("CLIGameDB");
    db.version(1).stores({ players: "tag" });

    const $ = (id) => document.getElementById(id);
    const print = (text) => $("output").innerText += text + "\n";
    const updateProfileBar = () => {
      if (!player) return;
      $("profileBar").innerText =
        `| tag : ${player.tag} | cash : ${player.cash} | age : ${getAge()} | job : ${player.job || 'none'} | income : ${player.wage || 0} |`;
    };

    let player = null;
    const jobs = { tech: 3, ceo: 5, cook: 2 };
    const items = { pager: 10, dvd: 5, tape: 3, cd: 4 };

    const getAge = () => {
      if (!player) return 0;
      const days = Math.floor((Date.now() - player.createdAt) / (1000 * 60 * 60 * 24));
      return days;
    };

    const saveToStorage = async () => {
      if (!player) return;
      await db.players.put(player);
    };

    const loadFromStorage = async () => {
      const all = await db.players.toArray();
      if (all.length) {
        player = all[0];
        print(`Auto login as ${player.tag}`);
        updateProfileBar();
      }
    };

    const autoPay = () => {
      setInterval(() => {
        if (player?.job) {
          player.cash += player.wage;
          print(`[Salary] +${player.wage} cash`);
          updateProfileBar();
          saveToStorage();
        }
      }, 600000); // 10 minutes
    };

    const commands = {
      signup: async (args) => {
        if (args[0]?.length < 6) return print("Password min 6 aksara");
        const tag = String(Math.floor(Math.random() * 1000)).padStart(3, '0');
        player = {
          tag,
          password: args[0],
          cash: 0,
          job: null,
          wage: 0,
          inventory: {},
          createdAt: Date.now(),
        };
        await db.players.clear();
        await db.players.put(player);
        print(`Signup berjaya! tag anda: ${tag}`);
        updateProfileBar();
      },
      login: async ([tag, password]) => {
        const found = await db.players.get(tag);
        if (found && found.password === password) {
          player = found;
          print(`Login sebagai ${tag}`);
          updateProfileBar();
        } else {
          print("Login gagal");
        }
      },
      reset: async () => {
        await db.players.clear();
        player = null;
        print("Akaun dipadam");
        updateProfileBar();
      },
      joblist: () => {
        print("Senarai kerja:");
        for (const [job, wage] of Object.entries(jobs)) print(`- ${job} : ${wage}`);
      },
      apply: ([job]) => {
        if (!player) return print("Login dulu");
        if (!jobs[job]) return print("Kerja tidak wujud");
        player.job = job;
        player.wage = jobs[job];
        updateProfileBar();
        print(`Anda sekarang bekerja sebagai ${job}`);
        saveToStorage();
      },
      resign: () => {
        if (!player) return;
        player.job = null;
        player.wage = 0;
        print("Anda telah berhenti kerja");
        updateProfileBar();
        saveToStorage();
      },
      itemlist: () => {
        print("Senarai item:");
        for (const [name, price] of Object.entries(items)) print(`- ${name} : ${price}`);
      },
      buy: ([item, qty]) => {
        if (!player) return;
        qty = parseInt(qty);
        if (!items[item] || qty <= 0) return print("Item tidak sah");
        const cost = items[item] * qty;
        player.cash -= cost;
        player.inventory[item] = (player.inventory[item] || 0) + qty;
        print(`Beli ${qty}x ${item} (-${cost} cash)`);
        updateProfileBar();
        saveToStorage();
      },
      sell: ([item, qty]) => {
        if (!player) return;
        qty = parseInt(qty);
        if (!player.inventory[item] || player.inventory[item] < qty) return print("Item tidak mencukupi");
        const refund = Math.floor((items[item] * qty) / 2);
        player.inventory[item] -= qty;
        player.cash += refund;
        print(`Jual ${qty}x ${item} (+${refund} cash)`);
        updateProfileBar();
        saveToStorage();
      },
      inv: () => {
        if (!player) return;
        print("Inventory:");
        for (const [item, qty] of Object.entries(player.inventory)) print(`- ${item} x${qty}`);
      },
      dice: ([bet]) => {
        if (!player) return;
        bet = parseInt(bet);
        if (bet < 5) return print("Min bet: 5");
        const npc = Math.floor(Math.random() * 20);
        const user = Math.floor(Math.random() * 20);
        const win = user >= npc;
        player.cash += win ? bet : -bet;
        print(`Dice ${user} vs NPC ${npc} â†’ ${win ? 'Menang' : 'Kalah'} (${win ? '+' : '-'}${bet})`);
        updateProfileBar();
        saveToStorage();
      },
      slots: ([bet]) => {
        if (!player) return;
        bet = parseInt(bet);
        if (bet < 5) return print("Min bet: 5");
        const symbols = ['ðŸ’', 'ðŸ””', 'ðŸ’Ž'];
        const roll = [0, 0, 0].map(() => symbols[Math.floor(Math.random() * symbols.length)]);
        const win = roll[0] === roll[1] && roll[1] === roll[2];
        print(`[ ${roll.join(' ')} ]`);
        player.cash += win ? bet : -bet;
        print(win ? `Menang +${bet}` : `Kalah -${bet}`);
        updateProfileBar();
        saveToStorage();
      },
      crime: ([level]) => {
        if (!player) return;
        const lvl = parseInt(level);
        if (![1, 2, 3].includes(lvl)) return print("Gunakan level 1-3");
        const success = Math.random() < (0.6 - lvl * 0.1);
        const reward = 10 * lvl + Math.floor(Math.random() * 10);
        const fine = 10 * lvl + Math.floor(Math.random() * 20);
        if (success) {
          player.cash += reward;
          print(`Crime berjaya! +${reward} cash`);
        } else {
          player.cash -= fine;
          print(`Crime gagal! Denda -${fine} cash`);
        }
        updateProfileBar();
        saveToStorage();
      },
      savefile: () => {
        if (!player) return;
        const blob = new Blob([JSON.stringify(player)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `zxvwp15.0_${player.tag}.json`;
        a.click();
      },
      loadfile: () => {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";
        input.onchange = async (e) => {
          const file = e.target.files[0];
          const reader = new FileReader();
          reader.onload = async () => {
            player = JSON.parse(reader.result);
            await db.players.clear();
            await db.players.put(player);
            print(`Fail dimuatkan sebagai ${player.tag}`);
            updateProfileBar();
          };
          reader.readAsText(file);
        };
        input.click();
      },
      help: () => {
        print(`ðŸ“Œ AKAUN
signup <password>            - Daftar pemain baru (password min. 6 aksara)
login <tag> <password>       - Login pemain sedia ada
reset                        - Padam akaun semasa

ðŸ§‘ PROFIL
| tag : <id> | cash : <x> | age : <hari> | job : <nama> | income : <gaji> |

ðŸ’¼ KERJA
joblist                     - Lihat senarai kerja & gaji
apply <jobname>             - Mohon kerja
resign                      - Berhenti kerja semasa

ðŸ›’ BARANG
itemlist                    - Lihat senarai item & harga
buy <item> <qty>            - Beli item
sell <item> <qty>           - Jual item (50% refund)
inv                         - Lihat item dimiliki

ðŸŽ² MINI GAME
dice <bet>                 - Bertaruh dadu (50% win, min 5)
slots <bet>                - Mesin slot (60% win, min 5)

ðŸ¦¹ CRIME
crime <level>              - Cuba jenayah (level 1-3, risiko/ganjaran ikut level)

ðŸ’¾ SIMPAN / MUAT NAIK
savefile                   - Simpan fail game ke telefon
loadfile                   - Muat naik fail .json

ðŸ”§ SISTEM
help                       - Senarai arahan`);
      }
    };

    $("input").addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const [cmd, ...args] = e.target.value.trim().split(" ");
        e.target.value = "";
        print("> " + cmd + " " + args.join(" "));
        if (commands[cmd]) {
          await commands[cmd](args);
        } else {
          print("Arahan tidak sah. Taip 'help'");
        }
      }
    });

    loadFromStorage();
    autoPay();
  </script>
</body>
</html>
